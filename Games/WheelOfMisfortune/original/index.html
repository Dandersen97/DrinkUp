<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>Wheel Of Misfortune</title>
		<!--<link href="../../css/bootstrap.min.3.4.1.css" rel="stylesheet">-->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    </head>
<body>
<style>
:root {
	--spinSec: 0ms;
	--spinMax: 0deg;
}
.startSpin{
	animation: rotation var(--spinSec) 1 forwards;
	animation-timing-function: cubic-bezier(0, 0.75, 0.75, 1.0);
	transform-origin: 100% 50%;
	}
@keyframes rotation {
	from {transform: rotate(0deg);}
	to   {transform: rotate(var(--spinMax));}
	}
.postSpin{
	transform: rotate(var(--spinMax));
	transform-origin: 100% 50%;
}

	.setting-option{
		background-color: rgba(145,145,145, 0.2);
	}
	
	.setting-option p{
		display: inline-block;
		margin: 10px 10px;
	}
	
	.setting-option button{
		display: inline-block;
	}
	

</style>
	<!-- Fixed navbar -->
	<div id="nav-placeholder"></div>
	
    <nav class="navbar navbar-default" style="margin-bottom: 0px;">
      <div class="container">
			<span class="navbar-brand" style="height: auto;">Wheel of Misfortune</span>
			<button class="btn btn-secondary navbar-btn" data-bs-toggle="modal" data-bs-target="#HowToPlayModal">How To Play</button>
        </div>
      </div>
    </nav>
		
	<div>
		<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="height:100%;" viewBox="250 0 250 500" >
			<g stroke-width="50%" fill="transparent" id="tire" class="startSpin" onclick='toggleSpin()' onanimationend='GetColor(event)'></g>
			<line x1="450" y1="250" x2="500" y2="250" stroke-width="8" stroke="black" />
		</svg>
	</div>
	<div class="modal fade" id="HowToPlayModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">How To Play</h5>
				</div>
				<div class="modal-body">
					<p>Tap the wheel to start spinning, then do whatever the spinner stops on.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="settingsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Settings</h5>
				</div>
				<div class="modal-body">
					<p>Add or Remove options for the wheel to land on. Make things more or less common to happen.</p>
					<div id="activeSegments">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="MisfortuneModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen">
			<div class="modal-content">

				<div class="modal-content" style="overflow-y: auto;">
					<img id="MisfortuneModalImg"  style="width: 100%;" />
					<span></span>
					<h1 id="MisfortuneModalTitle">Test 1</h1>
					<button data-bs-dismiss="modal"  class="btn btn-lg btn-primary">Close</button>
					<h3 id="MisfortuneModalDesc"></h3>
						<svg width="95vw" height="95vw" viewBox="250 0 250 500">
							<g stroke-width="50%" fill="transparent" id="MisfortuneModalMiniWheel" class="startSpin"></g>
							<line x1="450" y1="250" x2="500" y2="250" stroke-width="10" stroke="black" />
						</svg>

				
				</div>
			</div>
		</div>
	</div>


	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="/scripts/templateLoad.js"></script>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
	<!--<script src="../../scripts/bootstrap.min.js"></script> -->
	<div id="modalLogin-placeholder"></div>
<script>
	var optionsString = GetFile("spins.json");
	const jsonAllOptions = JSON.parse(optionsString);
	var ActiveOptions = JSON.parse(optionsString);

	function toggleSpin(){
		var spinner = document.getElementById("tire");
		spinner.classList.add("startSpin");
		spinner.classList.remove("postSpin");
		var spinPower = Math.trunc((Math.random() * 720) + 720);
		var spinSec = spinPower * 5;

		var r = document.querySelector(':root');
		r.style.setProperty('--spinMax', (spinPower * -1) + 'deg');
		r.style.setProperty('--spinSec', spinSec + 'ms');
		
		//spinner.style= 'transform: rotate(' + spinPower + 'deg); transform-origin: 50% 50%;';
	}

	
	function UpdateSlice(count){
		UpdateAllOptions();
		var spinner = document.getElementById("tire");
		var orgCount = spinner.getElementsByTagName("path").length;
		var newCount = orgCount + count;
		spinner.innerHTML = "";
		


		var startPoint = '0 0'; //translate(50,50)
		
		var radius = 250;
		var fPointX = radius;
		var fPointY = 0;
		var fPoint = fPointX + ' ' + fPointY; //very first point always radius,0
		
		
		var qPointX = Math.ceil(radius * Math.sin(360/newCount * Math.PI / 180.0));
		var qPointY = Math.ceil(radius * Math.cos(360/newCount * Math.PI / 180.0));
		var qPointX2 = Math.ceil((radius * .8) * Math.sin(360/newCount * Math.PI / 180.0));
		var qPointY2 = Math.ceil((radius * .8) * Math.cos(360/newCount * Math.PI / 180.0));
		var qPoint = qPointY + ' ' + qPointX;
		
		var qArcX = qPointX;
		var qArcY = fPointY;
		var qArc = qArcX + ' ' + qArcY;



		var segWidth = Math.sqrt(Math.pow(qPointY2 - (radius * .8) ,2) + Math.pow(qPointX2 - fPointY ,2))

		for(var i = 0; i < newCount; i++){
			var rotate = (360/newCount) * i;
			
			var imgSize = segWidth / 2;
			var imgX = (qPointY - ((qPointY2 - (radius * .8)) / 2)) - (imgSize / 2);
			var imgY = (qPointX - ((qPointX2 - fPointY) / 2)) - (imgSize / 2);
			//svg.innerHTML += '<path d="M ' + startPoint + ' L ' + fPoint + ' Q ' + qArc + ' ' + qPoint + ' L ' + startPoint + '" fill="blue" stroke="blue" stroke-width="1"/>'; //curved arc
			spinner.innerHTML += '<g transform="translate(' + radius + ',' + radius + ') rotate(' + rotate + ')">' + 
							'<path d="M ' + startPoint + ' L ' + fPoint + ' L ' + qPoint + ' L ' + startPoint + '" fill="' + ActiveOptions.Options[i].Color + '" stroke="black" stroke-width="1" />' +							
							'<image x="' + (imgX - (imgSize /2)) + '" y="' + (imgY - (imgSize /2)) + '" width="' + imgSize + 'px" height="' + imgSize + 'px" xlink:href="/images/Icons/' + ActiveOptions.Options[i].Icon + '.svg" style="transform-box: fill-box; transform-origin: center; transform: rotate(95deg);"></image>' +
							//'<circle cx="' + imgX + '" cy="' + imgY + '" r="5" fill="red"/>' +
							'</g>'; //straight line
			

		}
	

	}
	
	function Spin(){
		var spinner = document.getElementById("tire");
		spinner.classList.toggle("tire");
		var spinPower = Math.trunc((Math.random() * 720) + 720);
		var spinSec = spinPower * 5;

		var r = document.querySelector(':root');
		r.style.setProperty('--spinMax', spinPower + 'deg');
		r.style.setProperty('--spinSec', spinSec + 'ms');
		
		setTimeout(spinSec);
		
		spinner.classList.toggle("tire");
		spinner.style= 'transform: rotate(' + spinPower + 'deg); transform-origin: 50% 50%;';
	}
	
	function GetColor(ev){
		var spinner = document.getElementById("tire");
		spinner.classList.add("postSpin");
		spinner.classList.remove("startSpin");
		var spinVal = parseInt(getComputedStyle(spinner).getPropertyValue('--spinMax')) * -1;
		var orgCount = spinner.getElementsByTagName("path").length;
		var diff = 360 / orgCount;	
		var spinRemainer = (spinVal / 360) - Math.floor((spinVal / 360));

		//navigator.vibrate(100);
		document.getElementById("MisfortuneModalTitle").innerHTML = ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].ID;
		document.getElementById("MisfortuneModalDesc").innerHTML = ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].Desc;
		document.getElementById("MisfortuneModalImg").src = '/images/Icons//' + ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].Icon + '.svg';
		
		
		//console.log(ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].MiniWheel);
		//console.log(ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].MiniWheel.length);
		
		
		
		
		
		//miniwheel
		var count = ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].MiniWheel.length;
		if(count > 0) {
		var svg = document.getElementById("MisfortuneModalMiniWheel").parentElement;
			svg.style.display = "block";
		
		
		
		var startPoint = '0 0'; //translate(50,50)
		
		var radius = 250;
		var fPointX = radius;
		var fPointY = 0;
		var fPoint = fPointX + ' ' + fPointY; //very first point always radius,0

		
		var qPointX = Math.ceil(radius * Math.sin(360/count * Math.PI / 180.0));
		var qPointY = Math.ceil(radius * Math.cos(360/count * Math.PI / 180.0));
		var qPointX2 = Math.ceil((radius * .8) * Math.sin(360/count * Math.PI / 180.0));
		var qPointY2 = Math.ceil((radius * .8) * Math.cos(360/count * Math.PI / 180.0));
		var qPoint = qPointY + ' ' + qPointX;
		
		var qArcX = qPointX;
		var qArcY = fPointY;
		var qArc = qArcX + ' ' + qArcY;

		var segWidth = Math.sqrt(Math.pow(qPointY2 - (radius * .8) ,2) + Math.pow(qPointX2 - fPointY ,2))
		document.getElementById("MisfortuneModalMiniWheel").innerHTML = "";
		for(var i = 0; i < count; i++){
			var rotate = (360/count) * i;
			
			var imgSize = segWidth / 2;
			var imgX = (qPointY - ((qPointY2 - (radius * .8)) / 2)) - (imgSize / 2);
			var imgY = (qPointX - ((qPointX2 - fPointY) / 2)) - (imgSize / 2);
			//svg.innerHTML += '<path d="M ' + startPoint + ' L ' + fPoint + ' Q ' + qArc + ' ' + qPoint + ' L ' + startPoint + '" fill="blue" stroke="blue" stroke-width="1"/>'; //curved arc
			document.getElementById("MisfortuneModalMiniWheel").innerHTML += '<g transform="translate(' + radius + ',' + radius + ') rotate(' + rotate + ')">' + 
							'<path d="M ' + startPoint + ' L ' + fPoint + ' L ' + qPoint + ' L ' + startPoint + '" fill="' + "#86e98f" + '" stroke="black" stroke-width="1" />' +							
							'<image x="' + (imgX - (imgSize /2)) + '" y="' + (imgY - (imgSize /2)) + '" width="' + imgSize + 'px" height="' + imgSize + 'px" xlink:href="/images/numbers/' + ActiveOptions.Options[Math.ceil((spinRemainer * 360) / diff) - 1].MiniWheel[i] + '.svg" style="transform-box: fill-box; transform-origin: center; transform: rotate(108deg);"></image>' +
							//'<circle cx="' + imgX + '" cy="' + imgY + '" r="5" fill="red"/>' +
							'</g>'; //straight line
			

		}
		}
		else {
			var svg = document.getElementById("MisfortuneModalMiniWheel").parentElement;
			svg.style.display = "none";
		}

		$("#MisfortuneModal").modal('show');
		//window.navigator.vibrate(100);

	}
	
	function ToggleModal(mod){
		$(mod).modal('toggle');
		//var togMod = document.getElementById(mod);
		//togMod.classList.toggle("modal-vis");
	
	}
	
	function UpdateAllOptions(){
		//Get Active Options
		var listbox = document.getElementById("activeSegments");
		listbox.innerHTML = "";
		jsonAllOptions.Options.sort(function (a, b) {return a.ID < b.ID ? -1 : a.ID > b.ID ? 1 : 0;});
		for(var i = 0; i < jsonAllOptions.Options.length; i++){
			var count = ActiveOptions.Options.filter((obj) => obj.ID === jsonAllOptions.Options[i].ID).length;
			listbox.innerHTML += '<div class="setting-option">' + 						
									'<p>' + jsonAllOptions.Options[i].ID + '</p>' +
									'<button onclick=\'RemoveOption("' + jsonAllOptions.Options[i].ID +  '")\'>-</button>' +
									'<p>' + count + '</p>' +
									'<button onclick=\'AddOption("' + jsonAllOptions.Options[i].ID +  '")\'>+</button>' +
								 '</div>';
		}
		

	
	}
	
	function AddOption(option){
		var idx = ActiveOptions.Options.find(obj => obj.ID === option);

		ActiveOptions.Options.push(idx);
		UpdateSlice(1);		
	}
	
	function RemoveOption(option){
		var idx = ActiveOptions.Options.findIndex(obj => obj.ID === option);
	
		ActiveOptions.Options.splice(idx, 1);
		UpdateSlice(-1);
	}
	
window.onload = function() {
		UpdateSlice(ActiveOptions.Options.length);
	
	}
	
	/*
	function toggleNavbar(nav){
		console.log(nav);
		var navbar = document.getElementById(nav);
		var subNavs = document.getElementsByClassName("subnav");
		for (i = 0; i < subNavs.length; i++){
			subNavs[i].classList.add("collapse");
		};
		console.log(nav);
		console.log(navbar);
		navbar.classList.toggle("collapse");
	}
	*/
	function GetFile(url){	
		if (window.XMLHttpRequest){
					xmlhttp = new XMLHttpRequest();
				}
				else{
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				}
				var res = "";
				xmlhttp.open("GET", url, false);
				xmlhttp.send();
				if(xmlhttp.status === 200){
					res = xmlhttp.responseText;
				}		
		return res;
	}
</script>
    </body>
</html>
